# GPU Environment Lock v1 (VRA-29)

Path (relative to `Golden Draft/`): `docs/gpu/env_lock_v1.md`  
Repo path: `Golden Draft/docs/gpu/env_lock_v1.md`

This document pins the **minimum environment facts** required to interpret GPU
throughput/capacity runs and to separate real model/VRAM issues from platform
stall modes (WDDM/TDR, paging, sync traps, background contention).

Non-goals:
- This doc/tooling does **not** change registry settings (no TDR edits).
- This doc/tooling does **not** install drivers, CUDA toolkits, or packages.
- Any run-surface change requires a new version of this document.

Related contract (metrics + required artifacts):
- `Golden Draft/docs/gpu/objective_contract_v1.md`

---

## A) Run-Surface Decision (v1)

Decision (temporary, v1):
- Run surface: **Windows native (WDDM)**.

Alternatives (doc-only, not selected in v1):
- WSL2
- Linux bare metal

Policy:
- If we switch run surface, we must create `env_lock_v2.md` and re-baseline.

---

## B) Stall-Risk Checklist (Windows/WDDM)

Use this checklist before blaming the model:

### B.1 WDDM/TDR timeout risk
Symptoms:
- Sudden GPU reset, driver crash, or silent hang during long kernels.

Mitigations:
- Keep per-step latency low (avoid huge batches that create long kernels).
- Prefer shorter kernels / more frequent progress logs (without sync traps).
- For long-horizon runs, consider Linux/WSL2 (requires v2 re-baseline).

### B.2 VRAM oversubscription / paging spiral
Symptoms:
- Step time "explodes" (median/p95 jump), throughput collapses, machine feels frozen.

Mitigations:
- Respect VRAM guard in `objective_contract_v1.md` (default 0.92).
- Reduce batch size, reduce activation footprint, avoid fragmentation.

### B.3 Logging / sync traps
Symptoms:
- GPU utilization looks low, step time spikes; frequent host-device sync.

Common traps:
- `tensor.item()` in inner loops
- frequent `print()` in the step loop
- explicit `torch.cuda.synchronize()` per step

Mitigation:
- Keep train-critical logging minimal and buffered.

### B.4 Thermal / background contention
Symptoms:
- Throughput decays over time; clocks drop; background apps steal GPU/CPU.

Mitigations:
- Close heavy background apps; ensure adequate cooling; confirm clocks are stable.

---

## C) Canonical env.json Generation

Tool:
- `Golden Draft/tools/gpu_env_dump.py`

Canonical command (example):
```text
python "S:\AI\work\VRAXION_DEV\Golden Draft\tools\gpu_env_dump.py" --out-dir "S:\AI\work\VRAXION_DEV\bench_vault\_tmp\env_dump" --precision fp16 --amp 1
```

Expected stdout:
```text
WROTE env.json: S:\AI\work\VRAXION_DEV\bench_vault\_tmp\env_dump\env.json
```

---

## D) Example env.json (real output)

This example must be generated by `gpu_env_dump.py` (never handwritten).

```json
{
  "amp": 1,
  "compute_capability": "8.9",
  "cuda_driver_reported": "13.1",
  "cuda_version": "12.1",
  "driver_model": "WDDM",
  "driver_version": "591.74",
  "env_schema_version": "v1",
  "env_vars": {
    "CUDA_VISIBLE_DEVICES": null,
    "MKL_NUM_THREADS": null,
    "OMP_NUM_THREADS": null,
    "PYTORCH_CUDA_ALLOC_CONF": null
  },
  "errors": [],
  "generated_utc": "2026-02-04T11:28:32.062849+00:00",
  "git_commit": "29053e6773341a7631acf9791c89bf55a59fd4e7",
  "git_dirty": 1,
  "git_error": null,
  "gpu_name": "NVIDIA GeForce RTX 4070 Ti SUPER",
  "nvidia_smi_query": {
    "compute_cap": "8.9",
    "driver_model.current": "WDDM",
    "driver_version": "591.74",
    "memory.total": "16376",
    "name": "NVIDIA GeForce RTX 4070 Ti SUPER"
  },
  "nvidia_smi_raw": "Wed Feb  4 12:28:34 2026       \\n+-----------------------------------------------------------------------------------------+\\n| NVIDIA-SMI 591.74                 Driver Version: 591.74         CUDA Version: 13.1     |\\n+-----------------------------------------+------------------------+----------------------+\\n| GPU  Name                  Driver-Model | Bus-Id          Disp.A | Volatile Uncorr. ECC |\\n| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |\\n|                                         |                        |               MIG M. |\\n|=========================================+========================+======================|\\n|   0  NVIDIA GeForce RTX 4070 ...  WDDM  |   00000000:0A:00.0  On |                  N/A |\\n| 32%   54C    P5             22W /  285W |    2209MiB /  16376MiB |     35%      Default |\\n|                                         |                        |                  N/A |\\n+-----------------------------------------+------------------------+----------------------+\\n\\n+-----------------------------------------------------------------------------------------+\\n| Processes:                                                                              |\\n|  GPU   GI   CI              PID   Type   Process name                        GPU Memory |\\n|        ID   ID                                                               Usage      |\\n|=========================================================================================|\\n|    0   N/A  N/A            2696    C+G   ...indows\\\\System32\\\\ShellHost.exe      N/A      |\\n|    0   N/A  N/A            4216    C+G   ...n\\\\AdobeNotificationClient.exe      N/A      |\\n|    0   N/A  N/A            8904    C+G   C:\\\\Windows\\\\explorer.exe               N/A      |\\n|    0   N/A  N/A           12984    C+G   ...5n1h2txyewy\\\\TextInputHost.exe      N/A      |\\n|    0   N/A  N/A           15416    C+G   ...ntrolPanel\\\\SystemSettings.exe      N/A      |\\n|    0   N/A  N/A           16496    C+G   ...em32\\\\ApplicationFrameHost.exe      N/A      |\\n|    0   N/A  N/A           16896    C+G   ...IA app\\\\CEF\\\\NVIDIA Overlay.exe      N/A      |\\n|    0   N/A  N/A           17056    C+G   ...Chrome\\\\Application\\\\chrome.exe      N/A      |\\n|    0   N/A  N/A           17492    C+G   ...y\\\\StartMenuExperienceHost.exe      N/A      |\\n|    0   N/A  N/A           17588    C+G   ..._cw5n1h2txyewy\\\\SearchHost.exe      N/A      |\\n|    0   N/A  N/A           17892    C+G   ...IA app\\\\CEF\\\\NVIDIA Overlay.exe      N/A      |\\n|    0   N/A  N/A           17952    C+G   ...Chrome\\\\Application\\\\chrome.exe      N/A      |\\n|    0   N/A  N/A           18416    C+G   ...cw5n1h2txyewy\\\\WidgetBoard.exe      N/A      |\\n|    0   N/A  N/A           21012    C+G   ....0.3719.93\\\\msedgewebview2.exe      N/A      |\\n|    0   N/A  N/A           23512    C+G   ...am Files\\\\Hue Sync\\\\HueSync.exe      N/A      |\\n|    0   N/A  N/A           23812    C+G   ...xyewy\\\\ShellExperienceHost.exe      N/A      |\\n|    0   N/A  N/A           24220    C+G   ...em_tray\\\\lghub_system_tray.exe      N/A      |\\n|    0   N/A  N/A           28460    C+G   ....0.3719.93\\\\msedgewebview2.exe      N/A      |\\n|    0   N/A  N/A           40716    C+G   ...ms\\\\Microsoft VS Code\\\\Code.exe      N/A      |\\n+-----------------------------------------------------------------------------------------+\\n",
  "os": "Windows-10-10.0.26200-SP0",
  "precision": "fp16",
  "python_version": "3.11.0 (main, Oct 24 2022, 18:26:48) [MSC v.1933 64 bit (AMD64)]",
  "tool_version": "gpu_env_dump/1.0",
  "torch_version": "2.5.1+cu121",
  "total_vram_bytes": 17170956288
}
```

---

## E) Acceptance Checklist (VRA-29)

- `env_lock_v1.md` exists and includes:
  - explicit run-surface decision,
  - WDDM/TDR risk note (doc-only; no registry edits),
  - paging + logging sync trap checklist,
  - canonical command line,
  - embedded real env.json snippet produced by the tool.
- `gpu_env_dump.py` writes env.json with the **exact v1 schema** and ASCII-safe output.
